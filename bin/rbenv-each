#!/bin/bash
set -e

verbose=""

usage() {
  echo "Usage: rbenv each [-v] <command>"
  echo "       -v Verbose mode. Prints a header for each ruby."
}

while getopts ':vh' option; do
  case "$option" in
  'v') verbose=1 ;;
  'h') usage; exit 0 ;;
  '?')
    usage >&2
    exit 1
    ;;
  esac
done
shift $(($OPTIND-1))

if [ -z "$1" ]; then
  usage >&2
  exit 1
fi

failed_rubies=""

for ruby in $(rbenv versions --bare); do
  if [ -n "$verbose" ]; then
    echo -e "\033[1;34m[$ruby]:\033[0m \033[1;32m$@\033[0m";
    echo -e "\033[1;34m******************************************************************\033[0m";
  fi

  STATUS=0
  RBENV_VERSION="$ruby" "$@" || STATUS=$?
  [ $STATUS -eq 0 ] || failed_rubies="$failed_rubies $ruby"

  [ -n "$verbose" ] && echo
done

if [ -n "$failed_rubies" ]; then
  echo -e "\033[1;31mFAILED IN:$failed_rubies\033[0m"
fi
